{% extends 'base.html' %}

<!-- =========================== -->
<!--      üî∑ NAVBAR UTENTE       -->
<!-- =========================== -->
{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3 py-2 mb-4">
  <a class="navbar-brand fw-bold" href="#">
    üíº NomeBanca
  </a>

  <div class="ms-auto">
    <div class="dropdown">
      <button class="btn btn-outline-light dropdown-toggle" type="button" id="dropdownUser"
              data-bs-toggle="dropdown" aria-expanded="false">
        üë§ {{ utente.nome }} {{ utente.cognome }}
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUser">
        <li><h6 class="dropdown-header">Profilo utente</h6></li>

        <li>
          <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profiloModal">
            üìÑ Vedi Profilo
          </a>
        </li>

        <li><hr class="dropdown-divider"></li>

        <li>
          <form action="/logout" method="POST" class="m-0">
            <button type="submit" class="dropdown-item text-danger fw-bold">
              üö™ Logout
            </button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% endblock %}

<!-- =========================== -->
<!--       üî∑ CONTENUTO          -->
<!-- =========================== -->
{% block content %}

<div class="container mt-2" style="padding-top: 50px !important;">
    {% include 'flash_messages.html' %}

    <div class="d-flex justify-content-between align-items-center mb-3">

        <h4 class="m-0">üí≥ Conto</h4>

        {% if conti|length > 1 %}
        <form method="POST" action="{{ url_for('pagina_privata') }}" class="mx-3 flex-grow-1">
            <select name="conto_id" class="form-select fw-bold"
                    style="max-width: 325px; margin: 0 auto;" onchange="this.form.submit()">
                {% for c in conti %}
                    <option value="{{ c.id }}"
                        {% if c.id == conto_selezionato.id %}selected{% endif %}>
                        Conto {{ loop.index }} ‚Äî IBAN: {{ c.iban }}
                    </option>
                {% endfor %}
            </select>
        </form>
        {% endif %}

        <a href="{{ url_for('apri_nuovo_conto') }}" class="btn btn-primary btn-sm">
            ‚ûï Apri nuovo conto
        </a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body conto-info">
            <div class="d-flex justify-content-between align-items-center mb-2 conto-header">
                <span class="fw-bold fs-5">NomeBanca</span>

                <button class="btn btn-sm btn-outline-secondary" onclick="toggleSaldo(this)">üëÅÔ∏è</button>
            </div>

            <p class="text-muted mb-1"><strong>IBAN:</strong> {{ conto_selezionato.iban }}</p>

            <p class="saldo-masked text-muted">
                <strong>Saldo:</strong> ‚Ç¨ ****** 
            </p>

            <p class="saldo-full text-muted" style="display:none;">
                <strong>Saldo:</strong> ‚Ç¨ {{ "%.2f"|format(conto_selezionato.saldo_corrente) }}
            </p>
        </div>

        <div class="card-footer text-center small text-muted">
            {{ utente.nome }} {{ utente.cognome }}
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>üìÖ Ultimi Movimenti</h4>
        <a href="{{ url_for('effettua_bonifico') }}" class="btn btn-success">Effettua Bonifico</a>
    </div>

    <div class="card shadow-sm mb-5">
    {% if transazioni %}
      <div class="card-body p-0">
          <table class="table table-striped m-0">
              <thead class="table-dark">
                  <tr>
                      <th>Data</th>
                      <th>Importo</th>
                      <th>Descrizione</th>
                      <th>Tipo</th>
                  </tr>
              </thead>
              <tbody>
                  {% for t in transazioni %}
                  
                  {# √à USCITA SE IL CONTO SELEZIONATO √à IL MITTENTE #}
                  {% set is_uscita = (t.conto_mittente_id == conto_selezionato.id) %}

                  <tr>
                      <td>{{ t.data.strftime("%d/%m/%Y %H:%M") }}</td>

                      <!-- IMPORTO colorato e con + / ‚àí -->
                      <td class="fw-bold {% if is_uscita %}text-danger{% else %}text-success{% endif %}">
                          {% if is_uscita %}
                              - ‚Ç¨ {{ "%.2f"|format(t.importo) }}
                          {% else %}
                              + ‚Ç¨ {{ "%.2f"|format(t.importo) }}
                          {% endif %}
                      </td>

                      <td>{{ t.descrizione }}</td>

                      <!-- ETICHETTA TIPO: Entrata/Uscita -->
                      <td>
                          {% if is_uscita %}
                              <span class="text-danger">Uscita</span>
                          {% else %}
                              <span class="text-success">Entrata</span>
                          {% endif %}
                      </td>
                  </tr>

                  {% endfor %}
              </tbody>
          </table>
        </div>
        {% else %}
            <div class="p-3 text-center text-muted">
                Nessuna transazione per questo conto.
            </div>
        {% endif %}
    </div>


</div>

<!-- =========================== -->
<!--       üî∑ MODALE PROFILO      -->
<!-- =========================== -->
<div class="modal fade" id="profiloModal" tabindex="-1" aria-labelledby="profiloModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="profiloModalLabel">Profilo Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p><strong>Nome:</strong> {{ utente.nome }}</p>
        <p><strong>Cognome:</strong> {{ utente.cognome }}</p>

        {% if utente.lavoro %}
            <p><strong>Lavoro:</strong> {{ utente.lavoro.nome_lavoro }}</p>
            <p><strong>Stipendio:</strong> ‚Ç¨{{ "%.2f"|format(utente.lavoro.stipendio_mensile) }}</p>
        {% else %}
            <p><strong>Lavoro:</strong> Disoccupato</p>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>

    </div>
  </div>
</div>

<script>
function toggleSaldo(button) {
    const card = button.closest(".card-body");
    const masked = card.querySelector(".saldo-masked");
    const full = card.querySelector(".saldo-full");

    if (full.style.display === "none") {
        full.style.display = "block";
        masked.style.display = "none";
        button.textContent = "üôà";
    } else {
        full.style.display = "none";
        masked.style.display = "block";
        button.textContent = "üëÅÔ∏è";
    }
}
</script>

{% endblock %}
